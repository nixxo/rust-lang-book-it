name: BookToGithubPages

on:
  push:
    tags:
      - 'ch*'
  #  branches: ["it-translation"]
  workflow_dispatch:

jobs:
  build:
    name: build
    runs-on: ubuntu-latest
    permissions:
      contents: write  # To push a branch 
      pull-requests: write  # To create a PR from that branch
    env:
      MDBOOK_VERSION: '0.4.52'
      # MDBOOK_VERSION: '0.4.45'
    steps:
    - uses: actions/checkout@master
    - name: Update rustup
      run: rustup self update
    - name: Install Rust
      run: |
        rustup set profile minimal
        rustup toolchain install 1.85 -c rust-docs
        rustup default 1.85
    - name: Install mdbook
      run: |
        mkdir bin
        curl -sSL https://github.com/rust-lang/mdBook/releases/download/v$MDBOOK_VERSION/mdbook-v$MDBOOK_VERSION-x86_64-unknown-linux-gnu.tar.gz | tar -xz --directory=bin
        echo "$(pwd)/bin" >> "${GITHUB_PATH}"
    - name: Install mdbook-trpl binaries
      run: cargo install --path packages/mdbook-trpl
    - name: Build 
      run: |
        mdbook build
      # cargo run --bin lfp src
    - name: Validate references
      run: bash ci/validate.sh
    - name: Translate book.js
      run: bash ci/translate_mbook.sh

    - name: Upload pages artifacts
      uses: actions/upload-pages-artifact@v3
      with:
        path: book

  # Deploy job
  deploy:
    # Add a dependency to the build job
    needs: build

    # Grant GITHUB_TOKEN the permissions required to make a Pages deployment
    permissions:
      pages: write      # to deploy to Pages
      id-token: write   # to verify the deployment originates from an appropriate source

    # Deploy to the github-pages environment
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    # Specify runner + deployment step
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4 # or specific "vX.X.X" version tag for this action
